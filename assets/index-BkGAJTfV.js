(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function e(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=e(o);fetch(o.href,s)}})();const T=5,C=5,u=200;function R(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var B,P;function W(){if(P)return B;P=1,B=class{constructor(o,s){this.xs=o,this.ys=s,this.ks=this.getNaturalKs(new Float64Array(this.xs.length))}getNaturalKs(o){const s=this.xs.length-1,i=t(s+1,s+2);for(let r=1;r<s;r++)i[r][r-1]=1/(this.xs[r]-this.xs[r-1]),i[r][r]=2*(1/(this.xs[r]-this.xs[r-1])+1/(this.xs[r+1]-this.xs[r])),i[r][r+1]=1/(this.xs[r+1]-this.xs[r]),i[r][s+1]=3*((this.ys[r]-this.ys[r-1])/((this.xs[r]-this.xs[r-1])*(this.xs[r]-this.xs[r-1]))+(this.ys[r+1]-this.ys[r])/((this.xs[r+1]-this.xs[r])*(this.xs[r+1]-this.xs[r])));return i[0][0]=2/(this.xs[1]-this.xs[0]),i[0][1]=1/(this.xs[1]-this.xs[0]),i[0][s+1]=3*(this.ys[1]-this.ys[0])/((this.xs[1]-this.xs[0])*(this.xs[1]-this.xs[0])),i[s][s-1]=1/(this.xs[s]-this.xs[s-1]),i[s][s]=2/(this.xs[s]-this.xs[s-1]),i[s][s+1]=3*(this.ys[s]-this.ys[s-1])/((this.xs[s]-this.xs[s-1])*(this.xs[s]-this.xs[s-1])),h(i,o)}getIndexBefore(o){let s=0,i=this.xs.length,r=0;for(;s<i;)r=Math.floor((s+i)/2),this.xs[r]<o&&r!==s?s=r:this.xs[r]>=o&&r!==i?i=r:i=s;return s+1}at(o){let s=this.getIndexBefore(o);const i=(o-this.xs[s-1])/(this.xs[s]-this.xs[s-1]),r=this.ks[s-1]*(this.xs[s]-this.xs[s-1])-(this.ys[s]-this.ys[s-1]),a=-this.ks[s]*(this.xs[s]-this.xs[s-1])+(this.ys[s]-this.ys[s-1]);return(1-i)*this.ys[s-1]+i*this.ys[s]+i*(1-i)*(r*(1-i)+a*i)}};function h(n,o){const s=n.length;let i=0,r=0;for(;i<s&&r<=s;){let c=0,l=-1/0;for(let d=i;d<s;d++){const f=Math.abs(n[d][r]);f>l&&(c=d,l=f)}if(n[c][r]===0)r++;else{e(n,i,c);for(let d=i+1;d<s;d++){const f=n[d][r]/n[i][r];n[d][r]=0;for(let y=r+1;y<=s;y++)n[d][y]-=n[i][y]*f}i++,r++}}for(let c=s-1;c>=0;c--){var a=0;n[c][c]&&(a=n[c][s]/n[c][c]),o[c]=a;for(let l=c-1;l>=0;l--)n[l][s]-=n[l][c]*a,n[l][c]=0}return o}function t(n,o){const s=[];for(let i=0;i<n;i++)s.push(new Float64Array(o));return s}function e(n,o,s){let i=n[o];n[o]=n[s],n[s]=i}return B}var $=W();const j=R($),M=[{x:[-4.78,-4.33,-3.62,-2.47,-.59,25],y:[2671.21,2114.06,1502.47,738.72,160.96,0]},{x:[-4.84,-3.2,1.06,8.07,16.78,25],y:[3840.35,2288.2,900.71,282.35,34.33,0]},{x:[-4.77,-3.06,1.41,11.88,25],y:[4976.63,3373.28,1825.7,751.06,82.32]},{x:[-4.53,-1.6,3.45,12.15,25],y:[5995.38,3746.83,2430.5,1293.77,312.22]},{x:[-3.37,-.98,4.52,12.28,25],y:[5997.16,4565.09,3088.67,1848.82,504.82]},{x:[-1.66,1.86,6.69,13.6,25],y:[6021.85,4582.88,3462.22,2231.19,726.98]},{x:[.6,3.59,8.42,14.83,25],y:[5994.88,5027.58,3835.77,2514.88,924.79]}],G=M.map(h=>new j(h.x,h.y));function K(h,t){if(!(t<M[h].x[0]||t>M[h].x[M[h].x.length-1]))return G[h].at(t)}function _(h,t){if(t.muscle==null)return;const e=h,n=t.muscle.force;let o=[];for(let c=0;c<=6;c++){const l=K(c,e);l?o.push(Math.abs(l-n)):o.push(void 0)}const s=o.filter(c=>c!=null).length;if(s==0)return;if(s==1)return o.filter(c=>c!=null)[0];const i=o.map((c,l)=>({value:c||9999,index:l})).sort((c,l)=>c.value-l.value).slice(0,2),r=i[0].index*i[1].value+i[1].index*i[0].value,a=i[0].value+i[1].value;return r/a}class m{x;y;constructor(t=0,e=0){this.x=t,this.y=e}add(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}scale(t){return this.x*=t,this.y*=t,this}clone(){return new m(this.x,this.y)}distance(t){const e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)}}class k{pos;oldPos;forces;mass;invMass;pinned;constructor(t,e,n,o=!1){this.pos=new m(t,e),this.oldPos=new m(t,e),this.forces=new m(0,0),this.mass=n,this.pinned=o,this.invMass=o||n===0?0:1/n}update(t,e=.96){if(this.pinned)return;const n=this.forces.x*this.invMass,o=this.forces.y*this.invMass,s=(this.pos.x-this.oldPos.x)*e,i=(this.pos.y-this.oldPos.y)*e;this.oldPos.x=this.pos.x,this.oldPos.y=this.pos.y,this.pos.x+=s+n*t*t,this.pos.y+=i+o*t*t,this.forces.x=0,this.forces.y=0}}class w{nodeA;nodeB;targetLength;constructor(t,e,n){this.nodeA=t,this.nodeB=e,this.targetLength=n??t.pos.distance(e.pos)}solve(){const t=this.nodeA.pos.x-this.nodeB.pos.x,e=this.nodeA.pos.y-this.nodeB.pos.y,n=Math.sqrt(t*t+e*e);if(n==0)return;const o=(n-this.targetLength)/n,s=1/(this.nodeA.invMass+this.nodeB.invMass),i=t*o*s,r=e*o*s;this.nodeA.pinned||(this.nodeA.pos.x-=i*this.nodeA.invMass,this.nodeA.pos.y-=r*this.nodeA.invMass),this.nodeB.pinned||(this.nodeB.pos.x+=i*this.nodeB.invMass,this.nodeB.pos.y+=r*this.nodeB.invMass)}}class z extends w{slackLength=2;accumulatedCorrection=0;force=0;setLength(t){this.targetLength=t}contract(t){this.setLength(this.slackLength*(1-t*1/100))}resetSensor(){this.accumulatedCorrection=0,this.force=0}solve(){const t=this.nodeA.pos.x-this.nodeB.pos.x,e=this.nodeA.pos.y-this.nodeB.pos.y,n=Math.sqrt(t*t+e*e);if(n===0)return;let o=n-this.targetLength;if(o<0)return;this.accumulatedCorrection+=o;const s=o/n,i=this.nodeA.invMass+this.nodeB.invMass;if(i===0)return;const r=1/i,a=t*s*r,c=e*s*r;this.nodeA.pinned||(this.nodeA.pos.x-=a*this.nodeA.invMass,this.nodeA.pos.y-=c*this.nodeA.invMass),this.nodeB.pinned||(this.nodeB.pos.x+=a*this.nodeB.invMass,this.nodeB.pos.y+=c*this.nodeB.invMass)}computeForce(t,e){const n=this.nodeA.invMass+this.nodeB.invMass;if(n===0||t===0||e===0)return;const o=t/e,s=this.accumulatedCorrection/(t*o*n),i=.2;this.force=this.force*(1-i)+s*i}}class X{particles=[];hoseLinks=[];leverLinks=[];muscle=null;stiffness;hoseLength;constructor(t,e,n,o,s,i){const r=o/n,a=s/(n+1);for(let c=0;c<=n;c++){const l=c==0,d=new k(t,e+c*r,a,l);if(this.particles.push(d),c>0){const f=this.particles[c-1];this.hoseLinks.push(new w(f,d))}}this.stiffness=i,this.hoseLength=this.particles.length}attachMuscle(t,e,n,o){const s=this.particles[t],i=this.particles[t+1],r=i.pos.x-s.pos.x,a=i.pos.y-s.pos.y,c=Math.sqrt(r*r+a*a),l=-a/c*e,d=r/c*e,f=(s.pos.x+i.pos.x)*.5,y=(s.pos.y+i.pos.y)*.5,v=new k(f+l,y+d,.1);this.particles.push(v);const O=new w(s,v),E=new w(i,v);this.leverLinks.push(O,E);const A=new k(n,o,0,!0);this.particles.push(A),this.muscle=new z(v,A)}update(t){this.muscle?.resetSensor();for(const e of this.particles)e.forces.y+=e.mass*9.81;this.applyBending();for(const e of this.particles)e.update(t);for(let e=0;e<5;e++){for(const n of this.hoseLinks)n.solve();for(let n=0;n<10;n++)for(const o of this.leverLinks)o.solve();this.muscle&&this.muscle.solve()}this.muscle?.computeForce(t,5)}applyBending(){for(let t=1;t<this.hoseLength-1;t++){const e=this.particles[t-1],n=this.particles[t],o=this.particles[t+1],s=(e.pos.x+o.pos.x)*.5,i=(e.pos.y+o.pos.y)*.5,r=s-n.pos.x,a=i-n.pos.y;n.forces.x+=r*this.stiffness,n.forces.y+=a*this.stiffness;const c=r*this.stiffness*.5,l=a*this.stiffness*.5;e.forces.x-=c,e.forces.y-=l,o.forces.x-=c,o.forces.y-=l}}}class J{ctx;constructor(t){this.ctx=t.getContext("2d")}renderGraphics(t){this.clear(),this.drawHose(t),this.drawMuscle(t),this.drawLever(t),this.drawAttachment(t)}clear(){this.ctx.clearRect(0,0,T*u,C*u)}drawHose(t){const{ctx:e}=this;if(!(t.hoseLength<2)){e.beginPath(),e.strokeStyle="white",e.lineWidth=.06*u,e.lineCap="round";for(const n of t.hoseLinks)e.moveTo(n.nodeA.pos.x*u,n.nodeA.pos.y*u),e.lineTo(n.nodeB.pos.x*u,n.nodeB.pos.y*u);e.stroke()}}drawLever(t){const{ctx:e}=this;if(t.leverLinks.length===0)return;e.beginPath(),e.strokeStyle="white",e.lineWidth=5;for(const o of t.leverLinks)e.moveTo(o.nodeA.pos.x*u,o.nodeA.pos.y*u),e.lineTo(o.nodeB.pos.x*u,o.nodeB.pos.y*u);e.stroke();const n=t.leverLinks[0].nodeB;e.fillStyle="white",e.beginPath(),e.arc(n.pos.x*u,n.pos.y*u,2,0,Math.PI*2),e.fill()}drawMuscle(t){const{ctx:e}=this;if(!t.muscle)return;const n=t.muscle.nodeA.pos,o=t.muscle.nodeB.pos;e.beginPath();const s=Math.min(t.muscle.force,1e3)*255/1e3;e.strokeStyle=`rgb(255, ${255-s}, ${255-s})`,e.lineWidth=3,e.setLineDash([4,10]),e.moveTo(n.x*u,n.y*u),e.lineTo(o.x*u,o.y*u),e.stroke(),e.setLineDash([])}drawAttachment(t){const{ctx:e}=this,n=t.particles[0].pos.x*u,o=t.particles[0].pos.y*u;e.rect(n-200,-5,400,o),e.lineWidth=10,e.stroke()}}const Q=document.querySelector("canvas"),q=document.querySelector("#load"),I=document.querySelector("#mass"),N=document.querySelector("#stiffness"),g=document.querySelector("#contraction"),U=document.querySelector("#update"),V=document.querySelector("#contraction_span"),Z=document.querySelector("#force"),ss=document.querySelector("#pressure"),x={x:T/2,y:.1*C},Y=3.45,S=.12,H=23,ts=0,D=6e3,es=new J(Q);let p=new X(x.x,x.y,8,Y,H,D);p.attachMuscle(4,S,x.x-S,x.y);window.onload=()=>{g.value="0",I.value=H.toString(),q.value=ts.toString(),N.value=D.toString(),g.addEventListener("input",()=>{L=Number(g.value),V.innerHTML=`${L}%`,p.muscle.contract(L)}),U.addEventListener("click",()=>{p=new X(x.x,x.y,8,Y,Number(I.value)+Number(q.value),Number(N.value)),p.attachMuscle(4,S,x.x-S,x.y),g.value="0"})};function ns(){p.muscle&&(Z.innerHTML=`<span>Load cell measurement</span><br>${Math.round(p.muscle.force*10)/10} N`)}function os(){const h=_(L,p);h&&(ss.innerHTML=`<span>Pneumatic muscle control signal</span><br>${Math.round(h*10)/10} bar`)}const F=1/200;let b=0,L=0;function is(){p.update(F),b%6==0&&es.renderGraphics(p),++b==24&&(ns(),os(),b=0)}setInterval(is,F*1e3);
