(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))e(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&e(i)}).observe(document,{childList:!0,subtree:!0});function t(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(o){if(o.ep)return;o.ep=!0;const n=t(o);fetch(o.href,n)}})();const P=5,b=5,c=200;class f{x;y;constructor(s=0,t=0){this.x=s,this.y=t}add(s){return this.x+=s.x,this.y+=s.y,this}sub(s){return this.x-=s.x,this.y-=s.y,this}scale(s){return this.x*=s,this.y*=s,this}clone(){return new f(this.x,this.y)}distance(s){const t=this.x-s.x,e=this.y-s.y;return Math.sqrt(t*t+e*e)}}class M{pos;oldPos;forces;mass;invMass;pinned;constructor(s,t,e,o=!1){this.pos=new f(s,t),this.oldPos=new f(s,t),this.forces=new f(0,0),this.mass=e,this.pinned=o,this.invMass=o||e===0?0:1/e}update(s,t=.96){if(this.pinned)return;const e=this.forces.x*this.invMass,o=this.forces.y*this.invMass,n=(this.pos.x-this.oldPos.x)*t,i=(this.pos.y-this.oldPos.y)*t;this.oldPos.x=this.pos.x,this.oldPos.y=this.pos.y,this.pos.x+=n+e*s*s,this.pos.y+=i+o*s*s,this.forces.x=0,this.forces.y=0}}class v{nodeA;nodeB;targetLength;constructor(s,t,e){this.nodeA=s,this.nodeB=t,this.targetLength=e??s.pos.distance(t.pos)}solve(){const s=this.nodeA.pos.x-this.nodeB.pos.x,t=this.nodeA.pos.y-this.nodeB.pos.y,e=Math.sqrt(s*s+t*t);if(e==0)return;const o=(e-this.targetLength)/e,n=1/(this.nodeA.invMass+this.nodeB.invMass),i=s*o*n,h=t*o*n;this.nodeA.pinned||(this.nodeA.pos.x-=i*this.nodeA.invMass,this.nodeA.pos.y-=h*this.nodeA.invMass),this.nodeB.pinned||(this.nodeB.pos.x+=i*this.nodeB.invMass,this.nodeB.pos.y+=h*this.nodeB.invMass)}}class D extends v{slackLength=2;accumulatedCorrection=0;force=0;setLength(s){this.targetLength=s}contract(s){this.setLength(this.slackLength*(1-s*1/100))}resetSensor(){this.accumulatedCorrection=0,this.force=0}solve(){const s=this.nodeA.pos.x-this.nodeB.pos.x,t=this.nodeA.pos.y-this.nodeB.pos.y,e=Math.sqrt(s*s+t*t);if(e===0)return;let o=e-this.targetLength;if(o<0)return;this.accumulatedCorrection+=o;const n=o/e,i=this.nodeA.invMass+this.nodeB.invMass;if(i===0)return;const h=1/i,a=s*n*h,r=t*n*h;this.nodeA.pinned||(this.nodeA.pos.x-=a*this.nodeA.invMass,this.nodeA.pos.y-=r*this.nodeA.invMass),this.nodeB.pinned||(this.nodeB.pos.x+=a*this.nodeB.invMass,this.nodeB.pos.y+=r*this.nodeB.invMass)}computeForce(s,t){const e=this.nodeA.invMass+this.nodeB.invMass;if(e===0||s===0||t===0)return;const o=s/t,n=this.accumulatedCorrection/(s*o*e),i=.2;this.force=this.force*(1-i)+n*i}}class q{particles=[];hoseLinks=[];leverLinks=[];muscle=null;stiffness;hoseLength;constructor(s,t,e,o,n,i){const h=o/e,a=n/(e+1);for(let r=0;r<=e;r++){const u=r==0,y=new M(s,t+r*h,a,u);if(this.particles.push(y),r>0){const g=this.particles[r-1];this.hoseLinks.push(new v(g,y))}}this.stiffness=i,this.hoseLength=this.particles.length}attachMuscle(s,t,e,o){const n=this.particles[s],i=this.particles[s+1],h=i.pos.x-n.pos.x,a=i.pos.y-n.pos.y,r=Math.sqrt(h*h+a*a),u=-a/r*t,y=h/r*t,g=(n.pos.x+i.pos.x)*.5,N=(n.pos.y+i.pos.y)*.5,m=new M(g+u,N+y,.1);this.particles.push(m);const H=new v(n,m),C=new v(i,m);this.leverLinks.push(H,C);const A=new M(e,o,0,!0);this.particles.push(A),this.muscle=new D(m,A)}update(s){this.muscle?.resetSensor();for(const t of this.particles)t.forces.y+=t.mass*9.81;this.applyBending();for(const t of this.particles)t.update(s);for(let t=0;t<5;t++){for(const e of this.hoseLinks)e.solve();for(let e=0;e<10;e++)for(const o of this.leverLinks)o.solve();this.muscle&&this.muscle.solve()}this.muscle?.computeForce(s,5)}applyBending(){for(let s=1;s<this.hoseLength-1;s++){const t=this.particles[s-1],e=this.particles[s],o=this.particles[s+1],n=(t.pos.x+o.pos.x)*.5,i=(t.pos.y+o.pos.y)*.5,h=n-e.pos.x,a=i-e.pos.y;e.forces.x+=h*this.stiffness,e.forces.y+=a*this.stiffness;const r=h*this.stiffness*.5,u=a*this.stiffness*.5;t.forces.x-=r,t.forces.y-=u,o.forces.x-=r,o.forces.y-=u}}}class O{ctx;constructor(s){this.ctx=s.getContext("2d")}renderGraphics(s){this.clear(),this.drawHose(s),this.drawMuscle(s),this.drawLever(s),this.drawAttachment(s)}clear(){this.ctx.clearRect(0,0,P*c,b*c)}drawHose(s){const{ctx:t}=this;if(!(s.hoseLength<2)){t.beginPath(),t.strokeStyle="white",t.lineWidth=.06*c,t.lineCap="round";for(const e of s.hoseLinks)t.moveTo(e.nodeA.pos.x*c,e.nodeA.pos.y*c),t.lineTo(e.nodeB.pos.x*c,e.nodeB.pos.y*c);t.stroke()}}drawLever(s){const{ctx:t}=this;if(s.leverLinks.length===0)return;t.beginPath(),t.strokeStyle="white",t.lineWidth=5;for(const o of s.leverLinks)t.moveTo(o.nodeA.pos.x*c,o.nodeA.pos.y*c),t.lineTo(o.nodeB.pos.x*c,o.nodeB.pos.y*c);t.stroke();const e=s.leverLinks[0].nodeB;t.fillStyle="white",t.beginPath(),t.arc(e.pos.x*c,e.pos.y*c,2,0,Math.PI*2),t.fill()}drawMuscle(s){const{ctx:t}=this;if(!s.muscle)return;const e=s.muscle.nodeA.pos,o=s.muscle.nodeB.pos;t.beginPath();const n=Math.min(s.muscle.force,1e3)*255/1e3;t.strokeStyle=`rgb(255, ${255-n}, ${255-n})`,t.lineWidth=3,t.setLineDash([4,10]),t.moveTo(e.x*c,e.y*c),t.lineTo(o.x*c,o.y*c),t.stroke(),t.setLineDash([])}drawAttachment(s){const{ctx:t}=this,e=s.particles[0].pos.x*c,o=s.particles[0].pos.y*c;t.rect(e-200,-5,400,o),t.lineWidth=10,t.stroke()}}const F=document.querySelector("canvas"),B=document.querySelector("#load"),S=document.querySelector("#mass"),k=document.querySelector("#stiffness"),W=document.querySelector("#update"),x=document.querySelector("#contraction"),E=document.querySelector("#contraction_span"),G=document.querySelector("#force"),d={x:P/2,y:.1*b},T=3.45,L=.12,X=23,$=0,Y=8e3,R=new O(F);let p=new q(d.x,d.y,8,T,X,Y);p.attachMuscle(4,L,d.x-L,d.y);window.onload=()=>{x.value="0",S.value=X.toString(),B.value=$.toString(),k.value=Y.toString(),x.addEventListener("input",()=>{const l=Number(x.value);E.innerHTML=`${l}%`,p.muscle.contract(l)}),W.addEventListener("click",()=>{p=new q(d.x,d.y,8,T,Number(S.value)+Number(B.value),Number(k.value)),p.attachMuscle(4,L,d.x-L,d.y),x.value="0"})};function K(){p.muscle&&(G.innerHTML=`<span>Load cell force</span>: ${Math.round(p.muscle.force*10)/10} N`)}const I=1/200;let w=0;function j(){p.update(I),w%6==0&&R.renderGraphics(p),++w==30&&(K(),w=0)}setInterval(j,I*1e3);
